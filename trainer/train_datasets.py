import torch
from datasets import load_dataset
from torch.utils.data import Dataset, DataLoader
from tqdm.auto import tqdm
from typing import List, Optional
import logging

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# --- PyTorch Dataset Classes ---
class TrainDataset(torch.utils.data.Dataset):
    def __init__(self, input_ids, attention_mask, labels):
        self.input_ids = torch.tensor(input_ids, dtype=torch.long) if not isinstance(input_ids, torch.Tensor) else input_ids
        self.attention_mask = torch.tensor(attention_mask, dtype=torch.long) if not isinstance(attention_mask, torch.Tensor) else attention_mask
        self.labels = torch.tensor(labels, dtype=torch.long) if not isinstance(labels, torch.Tensor) else labels

    def __len__(self):
        return self.input_ids.size(0)

    def __getitem__(self, idx):
        return {
            'input_ids': self.input_ids[idx],
            'attention_mask': self.attention_mask[idx],
            'labels': self.labels[idx]
        }

class TinyStoriesDataset(Dataset):
    def __init__(self, encodings):
        self.encodings = encodings

    def __len__(self):
        return self.encodings['input_ids'].size(0)

    def __getitem__(self, idx):
        return {
            'input_ids': self.encodings['input_ids'][idx],
            'attention_mask': self.encodings['attention_mask'][idx],
            'labels': self.encodings['labels'][idx]
        }

# --- Helper function for padding/truncation ---
def pad_and_truncate(token_ids: List[int], max_length: int, pad_id: int) -> (List[int], List[int]):
    """Pads or truncates a list of token IDs and creates attention mask."""
    if len(token_ids) > max_length:
        token_ids = token_ids[:max_length]
        attention_mask = [1] * max_length
    else:
        attention_mask = [1] * len(token_ids) + [0] * (max_length - len(token_ids))
        token_ids = token_ids + [pad_id] * (max_length - len(token_ids))
    return token_ids, attention_mask

# --- Adapted default_dataset function ---
def default_dataset(tokenizer, max_seq_length: int):
    """Creates a small default dataset for unsupervised pre-training."""
    logger.info("Creating default dataset...")

    try:
        bos_string = tokenizer.decode([tokenizer.bos_id])
        eos_string = tokenizer.decode([tokenizer.eos_id])
        pad_id = tokenizer.pad_id
        if pad_id is None or pad_id < 0:
             raise ValueError("Tokenizer must have a valid pad_id set.")
    except Exception as e:
        logger.error(f"Error getting BOS/EOS/PAD from tokenizer: {e}")
        raise

    logger.info(f"Using BOS: '{bos_string}' ({tokenizer.bos_id}), EOS: '{eos_string}' ({tokenizer.eos_id}), PAD: {pad_id}")

    texts = [
    "Rabbit hopped.",
    "Hopping rabbit.",
    "Cat slept.",
    "Sleeping cat.",
    "Dog chased.",
    "Chasing dog.",
    "Bird sang.",
    "Singing bird.",
    "Tom rode.",
    "Riding Tom.",
    "Fish swam.",
    "Swimming fish.",
    "Emma ate.",
    "Eating Emma.",
    "Butterfly flew.",
    "Flying butterfly.",
    "Teddy sat.",
    "Sitting teddy.",
    "Horse galloped.",
    "Galloping horse.",
    "Child laughed.",
      "Lion roared.",
    "Roaring lion.",
    "Tiger hunted.",
    "Hunting tiger.",
    "Elephant trumpeted.",
    "Trumpeting elephant.",
    "Zebra galloped.",
    "Galloping zebra.",
    "Giraffe reached.",
    "Reaching giraffe.",
    "Rhino charged.",
    "Charging rhino.",
    "Kangaroo hopped.",
    "Hopping kangaroo.",
    "Panda slept.",
    "Sleeping panda.",
    "Monkey swung.",
    "Swinging monkey.",
    "Koala rested.",
    "Resting koala.",
    "Cheetah sprinted.",
    "Sprinting cheetah.",
    "Camel trudged.",
    "Trudging camel.",
    "Leopard prowled.",
    "Prowling leopard.",
    "Eagle soared.",
    "Soaring eagle.",
    "Hawk flew.",
    "Flying hawk.",
    "Parrot squawked.",
    "Squawking parrot.",
    "Owl hooted.",
    "Hooting owl.",
    "Pelican dived.",
    "Diving pelican.",
    "Seal balanced.",
    "Balancing seal.",
    "Shark swam.",
    "Swimming shark.",
    "Dolphin jumped.",
    "Jumping dolphin.",
    "Whale breached.",
    "Breaching whale.",
    "Octopus crawled.",
    "Crawling octopus.",
    "Crab scuttled.",
    "Scuttling crab.",
    "Starfish rested.",
    "Resting starfish.",
    "Jellyfish drifted.",
    "Drifting jellyfish.",
    "Clownfish darted.",
    "Darting clownfish.",
    "Penguin waddled.",
    "Waddling penguin.",
    "Bat flitted.",
    "Flitting bat.",
    "Bee buzzed.",
    "Buzzing bee.",
    "Ant marched.",
    "Marching ant.",
    "Butterfly fluttered.",
    "Fluttering butterfly.",
    "Moth flew.",
    "Flying moth.",
    "Spider spun.",
    "Spinning spider.",
    "Dragonfly hovered.",
    "Hovering dragonfly.",
    "Ladybug crawled.",
    "Crawling ladybug.",
    "Grasshopper leapt.",
    "Leaping grasshopper.",
    "Beetle scurried.",
    "Scurrying beetle.",
    "Worm wriggled.",
    "Wriggling worm.",
    "Snail slithered.",
    "Slithering snail.",
    "Frog croaked.",
    "Croaking frog.",
    "Toad hopped.",
    "Hopping toad.",
    "Salamander crawled.",
    "Crawling salamander.",
    "Lizard basked.",
    "Basking lizard.",
    "Turtle plodded.",
    "Plodding turtle.",
    "Snake slithered.",
    "Slithering snake.",
    "Alligator swam.",
    "Swimming alligator.",
    "Crocodile lurked.",
    "Lurking crocodile.",
    "Bear lumbered.",
    "Lumbering bear.",
    "Wolf howled.",
    "Howling wolf.",
    "Fox trotted.",
    "Trotting fox.",
    "Rabbit darted.",
    "Darting rabbit.",
    "Squirrel scampered.",
    "Scampering squirrel.",
    "Mouse scurried.",
    "Scurrying mouse.",
    "Bat hung.",
    "Hanging bat.",
    "Otter slid.",
    "Sliding otter.",
    "Beaver gnawed.",
    "Gnawing beaver.",
    "Porcupine bristled.",
    "Bristling porcupine.",
    "Raccoon rummaged.",
    "Rummaging raccoon.",
    "Skunk sprayed.",
    "Spraying skunk.",
    "Chipmunk stuffed.",
    "Stuffing chipmunk.",
    "Hedgehog curled.",
    "Curling hedgehog.",
    "Bison roamed.",
    "Roaming bison.",
    "Moose wandered.",
    "Wandering moose.",
    "Reindeer grazed.",
    "Grazing reindeer.",
    "Camel rested.",
    "Resting camel.",
    "Lynx stalked.",
    "Stalking lynx.",
    "Wolverine prowled.",
    "Prowling wolverine.",
    "Jaguar padded.",
    "Padding jaguar.",
    "Cougar pounced.",
    "Pouncing cougar.",
    "Puma leapt.",
    "Leaping puma.",
    "Laughing child.",
    "Jaguar padded.",
    "Padding jaguar.",
    "Cougar pounced.",
    "Pouncing cougar.",
    "Puma leapt.",
    "Leaping puma.",
    "Leopard sprinted.",
    "Sprinting leopard.",
    "Cheetah chased.",
    "Chasing cheetah.",
    "Lion stalked.",
    "Stalking lion.",
    "Tiger prowled.",
    "Prowling tiger.",
    "Elephant trumpeted.",
    "Trumpeting elephant.",
    "Rhino charged.",
    "Charging rhino.",
    "Giraffe reached.",
    "Reaching giraffe.",
    "Kangaroo hopped.",
    "Hopping kangaroo.",
    "Panda rested.",
    "Resting panda.",
    "Koala slept.",
    "Sleeping koala.",
    "Monkey swung.",
    "Swinging monkey.",
    "Zebra trotted.",
    "Trotting zebra.",
    "Giraffe grazed.",
    "Grazing giraffe.",
    "Elephant roamed.",
    "Roaming elephant.",
    "Rhino wandered.",
    "Wandering rhino.",
    "Lion roamed.",
    "Roaming lion.",
    "Leopard rested.",
    "Resting leopard.",
    "Tiger lay.",
    "Lying tiger.",
    "Cheetah slept.",
    "Sleeping cheetah.",
    "Bear hibernated.",
    "Hibernating bear.",
    "Wolf howled.",
    "Howling wolf.",
    "Fox trotted.",
    "Trotting fox.",
    "Rabbit hopped.",
    "Hopping rabbit.",
    "Squirrel scampered.",
    "Scampering squirrel.",
    "Mouse scurried.",
    "Scurrying mouse.",
    "Otter slid.",
    "Sliding otter.",
    "Beaver gnawed.",
    "Gnawing beaver.",
    "Porcupine bristled.",
    "Bristling porcupine.",
    "Raccoon rummaged.",
    "Rummaging raccoon.",
    "Skunk sprayed.",
    "Spraying skunk.",
    "Chipmunk stuffed.",
    "Stuffing chipmunk.",
    "Hedgehog curled.",
    "Curling hedgehog.",
    "Bison roamed.",
    "Roaming bison.",
    "Moose wandered.",
    "Wandering moose.",
    "Reindeer grazed.",
    "Grazing reindeer.",
    "Camel rested.",
    "Resting camel.",
    "Lynx stalked.",
    "Stalking lynx.",
    "Wolverine prowled.",
    "Prowling wolverine.",
    "Jaguar padded.",
    "Padding jaguar.",
    "Cougar pounced.",
    "Pouncing cougar.",
    "Puma leapt.",
    "Leaping puma.",
    "Leopard sprinted.",
    "Sprinting leopard.",
    "Cheetah chased.",
    "Chasing cheetah.",
    "Lion stalked.",
    "Stalking lion.",
    "Tiger prowled.",
    "Prowling tiger.",
    "Elephant trumpeted.",
    "Trumpeting elephant.",
    "Rhino charged.",
    "Charging rhino.",
    "Giraffe reached.",
    "Reaching giraffe.",
    "Kangaroo hopped.",
    "Hopping kangaroo.",
    "Panda rested.",
    "Resting panda.",
    "Koala slept.",
    "Sleeping koala.",
    "Monkey swung.",
    "Swinging monkey.",
    "Zebra trotted.",
    "Trotting zebra.",
    "Giraffe grazed.",
    "Grazing giraffe.",
    "Elephant roamed.",
    "Roaming elephant.",
    "Rhino wandered.",
    "Wandering rhino.",
    "Lion roamed.",
    "Roaming lion.",
    "Leopard rested.",
    "Resting leopard.",
    "Man walked.",
    "Walking man.",
    "Girl danced.",
    "Dancing girl.",
    "Woman talked.",
    "Talking woman.",
    "Boy played.",
    "Playing boy.",
    "Lion roared.",
    "Roaring lion.",
    "Monkey jumped.",
    "Jumping monkey.",
    "Fish jumped.",
    "Jumping fish.",
    "Cat ran.",
    "Running cat.",
    "Dog barked.",
    "Barking dog.",
    "Bird flew.",
    "Flying bird.",
    "Baby cried.",
    "Crying baby.",
    "Man ran.",
    "Running man.",
    "Tree grew.",
    "Growing tree.",
    "Flower bloomed.",
    "Blooming flower.",
    "Cloud floated.",
    "Floating cloud.",
    "Wind blew.",
    "Blowing wind.",
    "Plane soared.",
    "Soaring plane.",
    "Sun set.",
    "Setting sun.",
    "Moon rose.",
    "Rising moon.",
    "Star twinkled.",
    "Twinkling star.",
    "Clouds drifted.",
    "Drifting clouds.",
    "River flowed.",
    "Flowing river.",
    "Rain fell.",
    "Falling rain.",
    "Snow melted.",
    "Melting snow.",
    "Tree swayed.",
    "Swaying tree.",
    "Leaves rustled.",
    "Rustling leaves.",
    "Ground shook.",
    "Shaking ground.",
    "Mountain stood.",
    "Standing mountain.",
    "River rushed.",
    "Rushing river.",
    "Thunder rumbled.",
    "Rumbling thunder.",
    "Lightning struck.",
    "Striking lightning.",
    "Wind howled.",
    "Howling wind.",
    "Fire burned.",
    "Burning fire.",
    "Ice cracked.",
    "Cracking ice.",
    "Sea roared.",
    "Roaring sea.",
    "Lake shimmered.",
    "Shimmering lake.",
    "Candle flickered.",
    "Flickering candle.",
    "Fish swirled.",
    "Swirling fish.",
    "Water splashed.",
    "Splashing water.",
    "Bird chirped.",
    "Chirping bird.",
    "Car raced.",
    "Racing car.",
    "Train sped.",
    "Speeding train.",
    "Bus stopped.",
    "Stopping bus.",
    "Bicycle moved.",
    "Moving bicycle.",
    "Motorcycle zoomed.",
    "Zooming motorcycle.",
    "Truck honked.",
    "Honking truck.",
    "Sailboat sailed.",
    "Sailing sailboat.",
    "Submarine dove.",
    "Diving submarine.",
    "Helicopter hovered.",
    "Hovering helicopter.",
    "Taxi arrived.",
    "Arriving taxi.",
    "Boat rocked.",
    "Rocking boat.",
    "Skater glided.",
    "Gliding skater.",
    "Rider galloped.",
    "Galloping rider.",
    "Pilot flew.",
    "Flying pilot.",
    "Driver drove.",
    "Driving driver.",
    "Farmer worked.",
    "Working farmer.",
    "Builder built.",
    "Building builder.",
    "Chef cooked.",
    "Cooking chef.",
    "Artist painted.",
    "Painting artist.",
    "Musician played.",
    "Playing musician.",
    "Teacher taught.",
    "Teaching teacher.",
    "Doctor healed.",
    "Healing doctor.",
    "Nurse cared.",
    "Caring nurse.",
    "Scientist researched.",
    "Researching scientist.",
    "Soldier marched.",
    "Marching soldier.",
    "Dancer performed.",
    "Performing dancer.",
    "Actor acted.",
    "Acting actor.",
    "Singer sang.",
    "Singing singer.",
    "Rabbit hopped quickly.",
    "Cat slept soundly.",
    "Dog chased ball.",
    "Bird sang song.",
    "Tom rode bike.",
    "Fish swam pond.",
    "Emma ate cupcake.",
    "Butterfly flew flowers.",
    "Teddy sat bed.",
    "Horse galloped field.",
    "Child laughed today.",
    "Man walked street.",
    "Girl danced party.",
    "Woman talked friend.",
    "Boy played toy.",
    "Lion roared today.",
    "Monkey jumped rock.",
    "Fish jumped water.",
    "Cat ran away.",
    "Dog barked outside.",
    "Bird flew tree.",
    "Baby cried night.",
    "Man ran fast.",
    "Tree grew tall.",
    "Flower bloomed spring.",
    "Cloud floated sky.",
    "Wind blew field.",
    "Plane soared clouds.",
    "Sun set mountains.",
    "Moon rose horizon.",
    "Star twinkled sky.",
    "Clouds drifted sky.",
    "River flowed downhill.",
    "Rain fell softly.",
    "Snow melted ground.",
    "Tree swayed wind.",
    "Leaves rustled breeze.",
    "Ground shook force.",
    "Mountain stood tall.",
    "River rushed ocean.",
    "Thunder rumbled distance.",
    "Lightning struck ground.",
    "Wind howled trees.",
    "Fire burned brightly.",
    "Ice cracked pressure.",
    "Sea roared shore.",
    "Lake shimmered moonlight.",
    "Candle flickered wind.",
    "Fish swirled water.",
    "Water splashed shore.",
    "Bird chirped outside.",
    "Car raced road.",
    "Train sped tracks.",
    "Bus stopped station.",
    "Bicycle moved path.",
    "Motorcycle zoomed road.",
    "Truck honked loudly.",
    "Sailboat sailed sea.",
    "Submarine dove fast.",
    "Helicopter hovered city.",
    "Taxi arrived station.",
    "Boat rocked dock.",
    "Skater glided rink.",
    "Rider galloped field.",
    "Pilot flew plane.",
    "Driver drove car.",
    "Farmer worked field.",
    "Builder built house.",
    "Chef cooked meal.",
    "Artist painted picture.",
    "Musician played melody.",
    "Teacher taught students.",
    "Doctor healed patients.",
    "Nurse cared children.",
    "Scientist researched theory.",
    "Soldier marched battle.",
    "Dancer performed stage.",
    "Actor acted movie.",
    "Singer sang song.",
    "Lion roared loudly.",
    "Tiger stalked silently.",
    "Elephant trumpeted loudly.",
    "Zebra trotted gracefully.",
    "Monkey swung high.",
    "Rabbit hopped quickly.",
    "Bear hibernated deeply.",
    "Fox ran fast.",
    "Giraffe reached high.",
    "Cheetah sprinted fast.",
    "Wolf howled loudly.",
    "Lion chased prey.",
    "Leopard prowled silently.",
    "Cheetah chased gazelle.",
    "Elephant wandered slowly.",
    "Tiger roared loudly.",
    "Wolf chased prey.",
    "Bison roamed freely.",
    "Fox trotted swiftly.",
    "Kangaroo hopped easily.",
    "Squirrel scampered quickly.",
    "Eagle soared high.",
    "Bear lumbered slowly.",
    "Rabbit ran swiftly.",
    "Raccoon scavenged food.",
    "Dolphin swam fast.",
    "Snake slithered silently.",
    "Panda rested peacefully.",
    "Koala slept soundly.",
    "Penguin waddled slowly.",
    "Hawk flew high.",
    "Otter slid playfully.",
    "Shark swam swiftly.",
    "Crocodile lurked quietly.",
    "Giraffe ate leaves.",
    "Hippo wallowed lazily.",
    "Elephant drank water.",
    "Rhino grazed peacefully.",
    "Leopard hid quietly.",
    "Zebra ran fast.",
    "Bat flew silently.",
    "Cheetah dashed quickly.",
    "Tiger stretched lazily.",
    "Lion napped peacefully.",
    "Koala clung tightly.",
    "Rabbit ate carrots.",
    "Penguin slid down.",
    "Monkey grabbed branch.",
    "Bear caught fish.",
    "Whale swam gently.",
    "Otter floated happily.",
    "Seagull flew high.",
    "Swan swam gracefully.",
    "Shark hunted prey.",
    "Horse galloped fast.",
    "Eagle soared above.",
    "Fox jumped quickly.",
    "Elephant stomped loudly.",
    "Lion chased zebra.",
    "Jaguar ran fast.",
    "Rabbit burrowed deep.",
    "Frog croaked loudly.",
    "Puma pounced quickly.",
    "Leopard leapt high.",
    "Owl hooted softly.",
    "Kangaroo boxed playfully.",
    "Hummingbird hovered briefly.",
    "Snake coiled tightly.",
    "Beaver gnawed wood.",
    "Koala chewed leaves.",
    "Panda munched bamboo.",
    "Tiger clawed tree.",
    "Squirrel climbed tree.",
    "Monkey swung branches.",
    "Zebra trotted slowly.",
    "Bear growled loudly.",
    "Raccoon washed paws.",
    "Fox chased rabbit.",
    "Lion licked paw.",
    "Horse trotted slowly.",
    "Frog leaped high.",
    "Bat flew swiftly.",
    "Penguin waddled slowly.",
    "Turtle moved slowly.",
    "Leopard rested quietly.",
    "Eagle landed softly.",
    "Shark swam near.",
    "Hawk flew quickly.",
    "Hummingbird hovered still.",
    "Duck quacked loudly.",
    "Swan glided smoothly.",
    "Crocodile swam silently.",
    "Dolphin leaped high.",
    "Otter splashed water.",
    "Bat roosted peacefully.",
    "Rabbit sniffed flowers.",
    "Bear hunted prey.",
    "Monkey jumped tree.",
    "Koala climbed tree.",
    "Squirrel gathered nuts.",
    "Tiger hunted deer.",
    "Fox sprinted fast.",
    "Horse galloped away.",
    "Elephant stomped loudly.",
    "Zebra trotted quickly.",
    "Lion attacked gazelle.",
    "Kangaroo kicked fast.",
    "Cheetah sprinted faster.",
    "Penguin waddled slowly.",
    "Giraffe ate grass.",
    "Wolf ran fast.",
    "Raccoon dug hole.",
    "Shark swam deep.",
    "Bat fluttered wings.",
    "Owl perched high.",
    "Eagle swooped low.",
    "Dolphin surfaced briefly.",
    "Whale breached water.",
    "Rabbit hopped twice.",
    "Puma pounced swiftly.",
    "Bear climbed rock.",
    "Tiger stretched limbs.",
    "Tiger prowled silently.",
    "Cheetah sprinted fast.",
    "Lion roared loudly.",
    "Wolf howled at moon.",
    "Bear roamed freely.",
    "Leopard stalked prey.",
    "Rabbit hopped quickly.",
    "Monkey swung tree.",
    "Fox ran fast.",
    "Elephant trumpeted loudly.",
    "Zebra galloped away.",
    "Eagle soared high.",
    "Shark hunted prey.",
    "Giraffe reached leaves.",
    "Kangaroo hopped easily.",
    "Otter slid gracefully.",
    "Penguin waddled slowly.",
    "Hawk flew swiftly.",
    "Dolphin swam fast.",
    "Koala slept soundly.",
    "Raccoon rummaged through.",
    "Squirrel scampered fast.",
    "Fox dug hole.",
    "Bear caught fish.",
    "Rabbit sniffed flowers.",
    "Penguin slid ice.",
    "Bat flew silently.",
    "Shark circled boat.",
    "Whale breached water.",
    "Crocodile lay still.",
    "Tiger rested peacefully.",
    "Monkey picked fruit.",
    "Eagle flew high.",
    "Lion chased prey.",
    "Jaguar padded quietly.",
    "Zebra grazed grass.",
    "Horse galloped freely.",
    "Koala clung tightly.",
    "Otter dove deep.",
    "Hummingbird hovered briefly.",
    "Panda munched bamboo.",
    "Bear lumbered slowly.",
    "Bat swooped down.",
    "Leopard climbed tree.",
    "Owl hooted softly.",
    "Swan swam elegantly.",
    "Cheetah ran fast.",
    "Elephant walked slowly.",
    "Penguin dived deep.",
    "Fox trotted swiftly.",
    "Kangaroo kicked high.",
    "Squirrel perched branch.",
    "Rabbit hopped away.",
    "Lion licked paw.",
    "Tiger climbed rock.",
    "Wolf sprinted fast.",
    "Dolphin leaped high.",
    "Whale swam gently.",
    "Otter floated leisurely.",
    "Crocodile swam silently.",
    "Zebra trotted along.",
    "Giraffe ate leaves.",
    "Bear rolled over.",
    "Horse galloped fast.",
    "Koala rested tree.",
    "Monkey swung vine.",
    "Elephant stomped loudly.",
    "Hawk glided high.",
    "Bat hung upside.",
    "Raccoon washed paws.",
    "Shark cruised deep.",
    "Cheetah chased gazelle.",
    "Lion napped peacefully.",
    "Zebra ran swiftly.",
    "Otter slid down.",
    "Penguin waddled slowly.",
    "Rabbit chewed grass.",
    "Fox darted quick.",
    "Horse trotted slowly.",
    "Koala chewed leaves.",
    "Swan glided slowly.",
    "Eagle circled above.",
    "Bear dug hole.",
    "Squirrel stored nuts.",
    "Shark attacked prey.",
    "Bat hung quietly.",
    "Penguin waddled over.",
    "Leopard dashed fast.",
    "Crocodile lurked deep.",
    "Raccoon climbed tree.",
    "Fox trotted away.",
    "Monkey groomed self.",
    "Hawk soared high.",
    "Lion attacked gazelle.",
    "Zebra stood still.",
    "Cheetah leapt high.",
    "Otter flipped water.",
    "Bear scratched tree.",
    "Whale swam slowly.",
    "Koala rested tree.",
    "Rabbit hopped low.",
    "Eagle perched high.",
    "Tiger prowled jungle.",
    "Leopard padded silently.",
    "Zebra grazed field.",
    "Horse trotted freely.",
    "Bear chased deer.",
    "Cheetah zoomed past.",
    "Puma stalked prey.",
    "Kangaroo bounded away.",
     "Bat flew low.",
    "Otter slid down.",
    "Eagle soared above.",
    "Cheetah chased prey.",
    "Lion stalked slowly.",
    "Zebra grazed calmly.",
    "Tiger stretched body.",
    "Fox scampered quickly.",
    "Bear rolled over.",
    "Squirrel perched branch.",
    "Leopard rested quietly.",
    "Monkey swung vines.",
    "Elephant trumpeted loud.",
    "Koala clung tree.",
    "Cheetah sprinted ahead.",
    "Penguin waddled slowly.",
    "Rabbit hopped fast.",
    "Kangaroo kicked high.",
    "Shark swam near.",
    "Fox scurried away.",
    "Lion licked paw.",
    "Swan swam gracefully.",
    "Eagle hovered high.",
    "Otter floated slowly.",
    "Tiger climbed tree.",
    "Bear rested quietly.",
    "Penguin waddled far.",
    "Fox jumped high.",
    "Squirrel ran fast.",
    "Raccoon climbed tree.",
    "Elephant stomped ground.",
     "Fox runs fast.",
    "Shark swims deep.",
    "Tiger prowls silently.",
    "Bear roams freely.",
    "Lion lies still.",
    "Elephant walks slowly.",
    "Rabbit hops high.",
    "Kangaroo jumps far.",
    "Monkey climbs trees.",
    "Wolf howls loud.",
    "Eagle soars above.",
    "Penguin waddles slowly.",
    "Koala rests quietly.",
    "Zebra trots calmly.",
    "Cheetah runs swiftly.",
    "Bat flies silently.",
    "Leopard prowls silently.",
    "Squirrel climbs fast.",
    "Otter swims gracefully.",
    "Dolphin leaps high.",
    "Whale swims slowly.",
    "Giraffe reaches leaves.",
    "Lion growls loudly.",
    "Fox darts quick.",
    "Penguin dives deep.",
    "Bear hunts prey.",
    "Rabbit burrows deep.",
    "Monkey swings fast.",
    "Cheetah sprints fast.",
    "Zebra runs wild.",
    "Horse gallops swiftly.",
    "Elephant roams quietly.",
    "Shark attacks prey.",
    "Wolf chases prey.",
    "Bat hangs upside.",
    "Swan glides smoothly.",
    "Lion stalks prey.",
    "Koala sleeps deeply.",
    "Eagle hunts prey.",
    "Fox digs hole.",
    "Squirrel gathers food.",
    "Bear catches fish.",
    "Rabbit nibbles grass.",
    "Tiger roars loudly.",
    "Wolf runs swiftly.",
    "Fox sniffs ground.",
    "Shark swims fast.",
    "Leopard leaps high.",
    "Otter plays happily.",
    "Monkey picks fruit.",
    "Elephant drinks water.",
    "Penguin waddles slowly.",
    "Bat flutters fast.",
    "Whale breaches water.",
    "Koala munches leaves.",
    "Lion chases gazelle.",
    "Cheetah pursues prey.",
    "Bear rests peacefully.",
    "Squirrel climbs tree.",
    "Rabbit jumps high.",
    "Wolf howls fiercely.",
    "Fox sneaks quietly.",
    "Elephant splashes water.",
    "Shark circles prey.",
    "Penguin slides ice.",
    "Monkey eats banana.",
    "Otter dives swiftly.",
    "Eagle flies high.",
    "Bat flies quickly.",
    "Tiger hunts alone.",
    "Bear digs hole.",
    "Zebra grazes field.",
    "Leopard rests quietly.",
    "Koala eats leaves.",
    "Rabbit hops quickly.",
    "Penguin dives deep.",
    "Shark hunts fish.",
    "Lion roams jungle.",
    "Cheetah runs fast.",
    "Eagle soars high.",
    "Bear follows trail.",
    "Fox jumps high.",
    "Wolf chases prey.",
    "Squirrel climbs tree.",
    "Tiger lies still.",
    "Monkey swings vines.",
    "Koala naps soundly.",
    "Penguin waddles far.",
    "Whale swims slowly.",
    "Otter slides down.",
    "Rabbit digs hole.",
    "Zebra eats grass.",
    "Shark swims near.",
    "Bat hangs still.",
    "Tiger stretches legs.",
    "Bear catches prey.",
    "Swan glides slowly.",
    "Monkey plays happily.",
    "Leopard hunts alone.",    
    "Fox runs fast.",
    "Lion lays down.",
    "Rabbit nibbles carrots.",
    "Eagle flies high.",
    "Penguin waddles away.", 
    "How are you?",
    "What’s your name?",
    "I am fine.",
    "Where is it?",
    "What’s happening here?",
    "I like that.",
    "Let’s go there.",
    "Can you help?",
    "It’s really nice.",
    "I’ll be back.",
    "I need that.",
    "Where are you?",
    "He is coming.",
    "She is busy.",
    "Can I join?",
    "I don’t know.",
    "I agree totally.",
    "You look great.",
    "I’ll see you.",
    "I’m feeling good.",
    "What’s for dinner?",
    "I’m not sure.",
    "Tell me more.",
    "Where is she?",
    "I’m on my way.",
    "What happened here?",
    "Can you explain?",
    "I love this.",
    "I’ll think about.",
    "It’s a deal.",
    "You got it.",
    "Let’s talk soon.",
    "I’m doing well.",
    "What’s your opinion?",
    "I don’t mind.",
    "I’m just thinking.",
    "What did you say?",
    "Let me check.",
    "Are you sure?",
    "That sounds good.",
    "It’s my turn.",
    "Are you free?",
    "How’s your day?",
    "I’ll call you.",
    "Can I go?",
    "I’m almost there.",
    "We should meet.",
    "That was fun.",
    "I need rest.",
    "How about lunch?",
    "Where’s the food?",
    "I don’t understand.",
    "What’s the time?",
    "Do you agree?",
    "I like that.",
    "Let’s go shopping.",
    "That’s amazing news.",
    "It was great.",
    "I’m so sorry.",
    "What do you think?",
    "Let’s get started.",
    "I’ll wait here.",
    "Are you okay?",
    "That sounds perfect.",
    "Can you wait?",
    "I’m listening now.",
    "It’s time, right?",
    "You’re welcome here.",
    "I don’t mind.",
    "Let’s go outside.",
    "I’ve got it.",
    "What’s your story?",
    "That’s incredible, right?",
    "Where do you live?",
    "I’m all set.",
    "Is this okay?",
    "Do you feel okay?",
    "I’m almost done.",
    "That sounds fun.",
    "I need a break.",
    "Let’s figure this.",
    "Where should we go?",
    "This looks nice.",
    "What do you want?",
    "That’s so kind.",
    "Do you mind?",
    "I’m just joking.",
    "Please don’t worry.",
    "How was work?",
    "That looks amazing.",
    "I agree with you.",
    "It was awesome.",
    "How’s everything going?",
    "I have an idea.",
    "Can you show me?",
    "This is great.",
    "Can I help?",
    "The cat jumped high.",
    "The dog ran fast.",
    "The bird flew away.",
    "The rabbit hopped quickly.",
    "The lion roared loudly.",
    "The wolf howled at night.",
    "The fox ran swiftly.",
    "The bear hibernated peacefully.",
    "The squirrel climbed trees.",
    "The eagle soared high.",
    "The monkey swung branches.",
    "The cheetah sprinted fast.",
    "The kangaroo hopped away.",
    "The zebra grazed peacefully.",
    "The dolphin swam gracefully.",
    "The turtle walked slowly.",
    "The rabbit sniffed flowers.",
    "The fish swam around.",
    "The owl hooted softly.",
    "The horse galloped fast.",
    "The giraffe ate leaves.",
    "The butterfly fluttered gently.",
    "The frog leapt high.",
    "The raccoon dug holes.",
    "The otter floated calmly.",
    "The panda chewed bamboo.",
    "The snake slithered silently.",
    "The lion chased prey.",
    "The tiger stretched slowly.",
    "The penguin waddled quickly.",
    "The bat flew silently.",
    "The deer jumped over.",
    "The wolf chased rabbit.",
    "The eagle flew low.",
    "The shark swam fast.",
    "The bear growled loudly.",
    "The koala rested peacefully.",
    "The horse trotted slowly.",
    "The bat swooped down.",
    "The rabbit hopped away.",
    "The fox sniffed ground.",
    "The crow cawed loudly.",
    "The squirrel scampered away.",
    "The lion sat quietly.",
    "The elephant stomped ground.",
    "The fish jumped high.",
    "The monkey grabbed fruit.",
    "The owl flew away.",
    "The wolf ran fast.",
    "The cheetah chased prey.",
    "The rabbit dug burrow.",
    "The frog sat still.",
    "The bear scratched tree.",
    "The kangaroo jumped high.",
    "The giraffe walked slowly.",
    "The zebra trotted along.",
    "The dolphin leaped high.",
    "The snake curled up.",
    "The raccoon washed paws.",
    "The panda slept soundly.",
    "The crow perched high.",
    "The tiger prowled silently.",
    "The kangaroo kicked high.",
    "The monkey swung high.",
    "The dog barked loudly.",
    "The owl hooted twice.",
    "The lion rested peacefully.",
    "The frog jumped high.",
    "The bear stood tall.",
    "The rabbit dug deep.",
    "The squirrel gathered food.",
    "The owl flew silently.",
    "The eagle soared gracefully.",
    "The fox chased prey.",
    "The lion roared loudly.",
    "The raccoon found food.",
    "The shark swam deep.",
    "The fox jumped over.",
    "The rabbit hopped fast.",
    "The tiger lay still.",
    "The lion stalked prey.",
    "The monkey swung vines.",
    "The cheetah raced fast.",
    "The panda ate bamboo.",
    "The bat hung upside.",
    "The zebra ran fast.",
    "The bear hunted prey.",
    "The fox sniffed around.",
    "The dog wagged tail.",
    "The wolf ran fast.",
    "The eagle landed softly.",
    "The giraffe stood tall.",
    "The frog croaked loudly.",
    "The raccoon washed paws.",
    "The rabbit hopped happily.",
    "The lion paced slowly.",
    "The crow flew high.",
    "The giraffe ate grass.",
    "The wolf sprinted fast.",
    "The tiger clawed tree.",
    "The bat flapped wings.",
    "The koala ate leaves.",
    "The panda rested quietly.",
    "The kangaroo bounded quickly.",
    "The elephant drank water."       
]

    all_input_ids = []
    all_attention_masks = []
    all_labels = []

    logger.info(f"Processing {len(texts)} text samples...")
    for text in tqdm(texts, desc="Tokenizing default dataset"):       

        token_ids = tokenizer.encode(
            text,
            bos=True,
            eos=True,
            allowed_special="all"
        )

        padded_token_ids, attention_mask = pad_and_truncate(token_ids, max_seq_length, pad_id)

        # Create labels with padding tokens (no -100)
        labels = padded_token_ids[1:] + [pad_id]
        
        # Mask labels where input was padding
        for i in range(max_seq_length):
            if attention_mask[i] == 0:
                labels[i] = pad_id

        assert len(labels) == max_seq_length

        all_input_ids.append(padded_token_ids)
        all_attention_masks.append(attention_mask)
        all_labels.append(labels)

    logger.info("Stacking tensors...")
    all_input_ids_tensor = torch.tensor(all_input_ids, dtype=torch.long)
    all_attention_masks_tensor = torch.tensor(all_attention_masks, dtype=torch.long)
    all_labels_tensor = torch.tensor(all_labels, dtype=torch.long)

    logger.info("Default dataset creation complete.")
    return TrainDataset(all_input_ids_tensor, all_attention_masks_tensor, all_labels_tensor)

# --- Adapted load_tinystories_dataset function ---
def load_tinystories_dataset(tokenizer, max_seq_length: int, split="train", max_samples=None, show_progress=True, skip_first=0):
    """Loads and processes the TinyStories dataset."""
    logger.info(f"Loading TinyStories dataset (split={split}, max_samples={max_samples}, skip={skip_first})...")

    try:
        bos_string = tokenizer.decode([tokenizer.bos_id])
        eos_string = tokenizer.decode([tokenizer.eos_id])
        pad_id = tokenizer.pad_id
        if pad_id is None or pad_id < 0:
             raise ValueError("Tokenizer must have a valid pad_id set.")
    except Exception as e:
        logger.error(f"Error getting BOS/EOS/PAD from tokenizer: {e}")
        raise

    logger.info(f"Using BOS: '{bos_string}' ({tokenizer.bos_id}), EOS: '{eos_string}' ({tokenizer.eos_id}), PAD: {pad_id}")

    use_streaming = max_samples is None or max_samples > 50000
    dataset = load_dataset("roneneldan/TinyStories", split=split, streaming=use_streaming)

    if skip_first > 0:
        logger.info(f"Skipping first {skip_first} samples...")
        if use_streaming:
            dataset = dataset.skip(skip_first)
        else:
            skip_first = min(skip_first, len(dataset))
            dataset = dataset.select(range(skip_first, len(dataset)))

    if max_samples is not None:
        logger.info(f"Taking max {max_samples} samples...")
        if use_streaming:
            dataset = dataset.take(max_samples)
        else:
            effective_max = min(max_samples, len(dataset))
            dataset = dataset.select(range(effective_max))

    all_input_ids = []
    all_attention_masks = []
    all_labels = []

    if show_progress:
         try:
             total = len(dataset) if not use_streaming else max_samples
             pbar = tqdm(total=total, desc=f"Processing TinyStories ({split})")
         except TypeError:
             pbar = tqdm(desc=f"Processing TinyStories ({split})")
    else:
         pbar = None

    processed_count = 0
    for example in dataset:
        text = example.get('text')
        if not text:
            logger.warning("No text found in example, skipping...")
            if pbar: pbar.update(1)
            continue

        try:
            token_ids = tokenizer.encode(
                text,
                bos=True,
                eos=True,
                allowed_special="all"
            )
        except Exception as e:
            logger.warning(f"Tokenization failed for an example, skipping. Error: {e}")
            if pbar: pbar.update(1)
            continue

        padded_token_ids, attention_mask = pad_and_truncate(token_ids, max_seq_length, pad_id)

        # Create labels with padding tokens (no -100)
        labels = padded_token_ids[1:] + [pad_id]
        
        # Mask labels where input was padding
        for i in range(max_seq_length):
            if attention_mask[i] == 0:
                labels[i] = pad_id

        assert len(labels) == max_seq_length

        all_input_ids.append(padded_token_ids)
        all_attention_masks.append(attention_mask)
        all_labels.append(labels)

        processed_count += 1
        if pbar: pbar.update(1)
        if max_samples is not None and use_streaming and processed_count >= max_samples:
            break

    if pbar: pbar.close()
    logger.info(f"Processed {processed_count} samples.")

    if not all_input_ids:
         logger.error("No data processed, returning empty dataset!")
         return TrainDataset(torch.empty((0, max_seq_length), dtype=torch.long),
                          torch.empty((0, max_seq_length), dtype=torch.long),
                          torch.empty((0, max_seq_length), dtype=torch.long))

    logger.info("Stacking tensors for TinyStories dataset...")
    all_input_ids_tensor = torch.tensor(all_input_ids, dtype=torch.long)
    all_attention_masks_tensor = torch.tensor(all_attention_masks, dtype=torch.long)
    all_labels_tensor = torch.tensor(all_labels, dtype=torch.long)

    encodings = {
        'input_ids': all_input_ids_tensor,
        'attention_mask': all_attention_masks_tensor,
        'labels': all_labels_tensor
    }

    logger.info("TinyStories dataset creation complete.")
    return TinyStoriesDataset(encodings)